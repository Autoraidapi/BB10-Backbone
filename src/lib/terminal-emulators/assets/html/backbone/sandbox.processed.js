var Sandbox={Model:Backbone.Model.extend({defaults:{history:[],iframe:!1,fallback:!0},initialize:function(){_.bindAll(this),this.fetch(),this.get("iframe")&&this.iframeSetup(),this.bind("destroy",(function(t){t.set({history:[]})}))},localStorage:new Store("SandboxConsole"),parse:function(t){return!_.isArray(t)||t.length<1||!t[0]?t:(t[0].history=_.map(t[0].history,(function(t){return t._hidden=!0,t.result&&delete t.result,t._class&&delete t._class,t})),delete t[0].iframe,t[0])},stringify:function(t){try{return JSON.stringify(t)}catch(e){return t.toString()}},addHistory:function(t){var e=this.get("history");return _.isString(t.result)&&(t.result='"'+t.result.toString().replace(/"/g,'\\"')+'"'),_.isFunction(t.result)&&(t.result=t.result.toString().replace(/"/g,'\\"')),_.isObject(t.result)&&(t.result=this.stringify(t.result).replace(/"/g,'\\"')),_.isUndefined(t.result)&&(t.result="undefined"),e.push(t),this.set({history:e}).change(),this.save(),this},iframeSetup:function(){this.sandboxFrame=$('<iframe width="0" height="0"/>').css({visibility:"hidden"}).appendTo("body")[0],this.sandbox=this.sandboxFrame.contentWindow,!this.sandbox.eval&&this.sandbox.execScript&&this.sandbox.execScript("null")},iframeEval:function(command){return this.sandbox||this.iframeSetup(),this.sandbox.eval?this.sandbox.eval(command):this.get("fallback")?eval(command):new Error("Can't evaluate inside the iframe - please report this bug along with your browser information!")},load:function(t){var e=document.createElement("script");return e.type="text/javascript",e.src=t,this.get("iframe")?this.sandboxFrame?this.sandboxFrame.contentDocument.body.appendChild(e):new Error("sandbox: iframe has not been created yet, cannot load "+t):document.body.appendChild(e)},evaluate:function(t){if(!t)return!1;var e={command:t};try{e.result=this.get("iframe")?this.iframeEval(t):eval.call(window,t),_.isUndefined(e.result)&&(e._class="undefined"),_.isNumber(e.result)&&(e._class="number"),_.isString(e.result)&&(e._class="string")}catch(t){e.result=t.toString(),e._class="error"}return this.addHistory(e)}}),View:Backbone.View.extend({initialize:function(t){_.bindAll(this),this.historyState=this.model.get("history").length,this.currentHistory="",this.resultPrefix=t.resultPrefix||"  => ",this.tabCharacter=t.tabCharacter||"\t",this.placeholder=t.placeholder||"// type some javascript and hit enter (:help for info)",this.helpText=t.helpText||"type javascript commands into the console, hit enter to evaluate. \n[up/down] to scroll through history, ':clear' to reset it. \n[alt + return/up/down] for returns and multi-line editing.",this.model.bind("change",this.update),this.el.delegate("textarea",{keydown:this.keydown,keyup:this.keyup}),this.el.delegate(".output",{click:this.focus}),this.render()},template:_.template($("#tplSandbox").html()),format:_.template($("#tplCommand").html()),render:function(){return this.el.html(this.template({placeholder:this.placeholder})),this.textarea=this.el.find("textarea"),this.output=this.el.find(".output"),this},update:function(){this.output.html(_.reduce(this.model.get("history"),(function(t,e){return t+this.format({_hidden:e._hidden,_class:e._class,command:this.toEscaped(e.command),result:this.toEscaped(e.result)})}),"",this)),this.textarea.val(this.currentHistory).attr("rows",this.currentHistory.split("\n").length),this.output.scrollTop(this.output[0].scrollHeight-this.output.height())},setValue:function(t){return this.currentHistory=t,this.update(),this.setCaret(this.textarea.val().length),this.textarea.focus(),!1},getCaret:function(){if(this.textarea[0].selectionStart)return this.textarea[0].selectionStart;if(document.selection){this.textarea[0].focus();var t=document.selection.createRange();if(null===t)return 0;var e=this.textarea[0].createTextRange(),i=e.duplicate();return e.moveToBookmark(t.getBookmark()),i.setEndPoint("EndToStart",e),i.text.length}return 0},setCaret:function(t){this.textarea[0].selectionStart=t,this.textarea[0].selectionEnd=t},toEscaped:function(t){return String(t).replace(/\\"/g,'"').replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},focus:function(t){return t.preventDefault(),this.textarea.focus(),!1},keydown:function(t){if(_([16,17,18]).indexOf(t.which,!0)>-1&&(this.ctrl=!0),13===t.which){t.preventDefault();var e=this.textarea.val();return this.ctrl?(this.currentHistory=e+"\n",this.update(),!1):(this.currentHistory="",this.specialCommands(e)||this.model.evaluate(e),this.historyState=this.model.get("history").length,!1)}if(!this.ctrl&&(38===t.which||40===t.which)){t.preventDefault();var i=this.model.get("history"),r=t.which-39;return this.historyState+=r,this.historyState<0?this.historyState=0:this.historyState>=i.length&&(this.historyState=i.length),this.currentHistory=i[this.historyState]?i[this.historyState].command:"",this.update(),!1}if(9===t.which){t.preventDefault();var s=this.textarea.val(),a=this.getCaret(),n=[s.slice(0,a),s.slice(a,s.length)];return this.textarea.val(n[0]+this.tabCharacter+n[1]),this.setCaret(a+this.tabCharacter.length),!1}},keyup:function(t){_([16,17,18]).indexOf(t.which,!0)>-1&&(this.ctrl=!1)},specialCommands:function(t){return":clear"===t?(this.model.destroy(),!0):":help"===t?this.model.addHistory({command:":help",result:this.helpText}):":parent"===t?this.model.addHistory({command:":parent",result:location.href}):t.indexOf(":load")>-1&&this.model.addHistory({command:t,result:this.model.load(t.substring(6))})}})};